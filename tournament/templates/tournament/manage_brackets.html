{% extends 'league/admin/base.html' %}
{% load bootstrap3 static league_tags tournament_tags%}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/league.css' %}"/>
{% endblock %}
{% block title %}Manage tournament brackets{% endblock %}
{% block heading %}
<div class="page-header">
    <h1>{{tournament.name}} brackets</h1>
</div>
{%endblock%}
{% block content %}
<div class="row">
  <div class="col-md-1">
    {% include 'tournament/includes/manage_menu.html' with active='brackets' %}
  </div>
  <div class = "col-md-2">
  {% if groups %}
  {% for group in groups %}
  <h2>{{group.name}}</h2>
  <div id="group_{{group.pk}}_players" data-group-name="{{group.name}}" class="panel-body group_players">
      {%for player in group.get_tournament_players %}
          <li data-id={{player.pk}} class="list-group-item">
            {{player.user | user_link}}
          </li>

        </li>
      {%endfor%}

</div>
  {% endfor %}
  {% else %}
  {% endif %}
</div>
  <div class = "col-md-9">
    <div class="row">
      <div class="panel panel-default">
        <div class="panel-heading"> Create a new Bracket
          <form action="" method="POST" class="form-inline" >
            {% csrf_token %}
            <button type="submit" formaction="{% url 'tournament:create_bracket' tournament.pk %}" class="btn btn-success btn-sm  pull-right">
              {% bootstrap_icon "plus" %}
            </button>
          </form>
          </div>
        </div>
    </div>
    {% for bracket in brackets %}
    <div class="row">
    {% with bracket.get_rounds as rounds %}
      {% for round in rounds %}

      <div class="col-md-2">
          {% for match in round.get_matchs %}
          <div class="panel panel-default">
              <div class="panel-body" id="match_{{match.pk}}" data-round="{{round.pk}}">
                  {% if match.player_1 %}
                  <li class="list-group-item" data-id={{player.pk}} data-round="{{round.pk}}">{{match.player_1}}</li>
                  {% endif %}
                  {% if match.player_2 %}
                  <li class="list-group-item" data-id={{player.pk}} data-round="{{round.pk}}">{{match.player_2}}</li>
                  {% endif %}
      </div>
    </div>
          {% endfor %}


  </div>


      {% endfor %}



  </div>
  </div>
    {% endwith %}

    {% endfor %}


{% endblock %}

{% block extra_js %}
<script src="{% static '/js/Sortable.min.js'%}"></script>


<script>
// ajax crfs setup
{% include 'league/includes/ajax_setup.html' %}

{% for group in groups %}
var group_{{group.pk}}_sortable = Sortable.create(group_{{group.pk}}_players,{
  group: {
    name: 'players_list',
    pull: 'clone',
    put: false,
  },
    sort: false,
});
{% endfor %}

{% for bracket in brackets %}
{% with bracket.get_rounds as rounds %}
  {% for round in rounds %}
      {% for match in round.get_matchs %}
        var match_{{match.pk}}_sortable = Sortable.create(match_{{match.pk}},{
          group: {
            name: 'players_list',
            pull: function (to){
                to = $(to.el)
                if (to.attr('data-round') <= {{round.pk}}){
                    return true;
                }
                else {
                    return 'clone';
                }
            },
            put: true
          },
            sort: true,
        });
{% endfor %}
{% endfor %}
{% endwith %}

{% endfor %}

</script>

{% endblock %}
